<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RDS 連鎖邏輯查詢系統</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root {
            --bg-color: #e0e5ec;
            --text-main: #4a5568;
            --text-highlight: #2d3748;
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            --accent-color: #667eea;
            --trip-color: #e53e3e;   /* 跳車紅 */
            --mech-color: #d69e2e;   /* 機械因素黃 */
            --proc-color: #3182ce;   /* 製程因素藍 */
        }

        /* 隱藏捲軸但保留功能 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 3px; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 15px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            touch-action: manipulation;
        }

        h1 {
            color: var(--text-highlight);
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5rem;
            text-shadow: 1px 1px 1px #fff;
        }

        #app-container {
            width: 100%;
            max-width: 600px;
            background: var(--bg-color);
            border-radius: 25px;
            padding: 20px;
            box-shadow: 12px 12px 24px var(--shadow-dark), 
                       -12px -12px 24px var(--shadow-light);
            min-height: 85vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* 按鈕共用樣式 */
        .btn {
            border: none;
            outline: none;
            background: var(--bg-color);
            color: var(--text-main);
            font-size: 1.1rem;
            font-weight: 600;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 6px 6px 12px var(--shadow-dark), 
                       -6px -6px 12px var(--shadow-light);
            transition: transform 0.1s ease;
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            cursor: pointer;
            box-sizing: border-box;
        }
        .btn:active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), 
                        inset -4px -4px 8px var(--shadow-light);
            transform: scale(0.98);
        }

        .btn-icon {
            font-size: 1.6rem;
            margin-right: 15px;
            width: 40px;
            text-align: center;
        }

        .btn-text { flex-grow: 1; }
        .arrow { color: var(--accent-color); font-weight: 900; font-size: 1.2rem; }

        /* 分類按鈕特別色 */
        .btn-process { border-left: 5px solid var(--proc-color); }
        .btn-mech { border-left: 5px solid var(--mech-color); }

        /* 搜尋框 */
        .search-box {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 50px;
            background: var(--bg-color);
            box-shadow: inset 5px 5px 10px var(--shadow-dark), 
                        inset -5px -5px 10px var(--shadow-light);
            font-size: 1rem;
            margin-bottom: 20px;
            color: var(--text-highlight);
            box-sizing: border-box;
        }
        .search-box:focus { outline: none; border: 1px solid var(--accent-color); }

        /* 表格容器 */
        .detail-card {
            background: var(--bg-color);
            border-radius: 20px;
            padding: 15px;
            box-shadow: inset 4px 4px 8px var(--shadow-dark), 
                        inset -4px -4px 8px var(--shadow-light);
            overflow-x: auto;
            flex-grow: 1;
        }

        table { width: 100%; border-collapse: collapse; min-width: 300px; }
        th { text-align: left; color: var(--accent-color); padding: 12px 8px; font-size: 0.95rem; border-bottom: 2px solid #cbd5e0; white-space: nowrap; }
        td { padding: 12px 8px; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.95rem; vertical-align: top; }
        
        .tag-no { color: var(--accent-color); font-family: 'Consolas', monospace; font-weight: 700; display: block; margin-top: 4px; font-size: 0.9rem; }
        .value { color: var(--trip-color); font-weight: 700; display: block; margin-top: 4px; }
        .type-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; color: #fff; margin-right: 5px; display: inline-block; margin-bottom: 4px;}

        .btn-back { margin-bottom: 15px; padding: 12px; text-align: center; display: block; color: var(--accent-color); font-weight: bold; border: 1px solid transparent; }
        
        /* Master Map 相關 */
        .map-container-wrapper { flex-grow: 1; display: flex; flex-direction: column; }
        .map-controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 10px; z-index: 10; }
        .zoom-btn {
            width: 45px; height: 45px; border-radius: 50%; border: none;
            background: var(--bg-color);
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            font-weight: bold; font-size: 1.5rem; color: var(--accent-color); cursor: pointer;
        }
        .zoom-btn:active { box-shadow: inset 2px 2px 5px var(--shadow-dark), inset -2px -2px 5px var(--shadow-light); }
        .mermaid-container {
            flex-grow: 1; overflow: auto; border-radius: 20px; padding: 0;
            background: #eef2f7;
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            display: flex; align-items: flex-start; justify-content: center;
        }

        /* 搜尋結果 */
        .search-result-item {
            background: var(--bg-color); margin-bottom: 15px; padding: 15px;
            border-radius: 15px; box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            border-left: 6px solid var(--accent-color); cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>RDS 連鎖系統</h1>

    <div id="app-container">
        <div id="display-area" style="width: 100%; height: 100%; display: flex; flex-direction: column;">
            </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true, 
            theme: 'base', 
            securityLevel: 'loose',
            flowchart: { curve: 'basis', htmlLabels: true, useMaxWidth: false },
            themeVariables: { primaryColor: '#e0e5ec', primaryTextColor: '#2d3748', lineColor: '#667eea', fontSize: '20px', fontFamily: 'arial' } 
        });

        // ==========================================
        // 資料庫：區分 Process (製程) 與 Mechanical (機械)
        // ==========================================
        const db = {
            "Compressor": {
                "C-2001A": {
                    "hasSub": true,
                    "Process": [
                        { reason: "一級進口低低壓力", tag: "PSLL-603 A/B/C", value: "14.8 kg/cm²", logic: "3選2" },
                        { reason: "一級出口高高溫度", tag: "TSHH-397 A/B/C", value: "149°C", logic: "3選2" },
                        { reason: "二級出口高高溫度", tag: "TSHH-398 A/B/C", value: "149°C", logic: "3選2" },
                        { reason: "三級出口高高溫度", tag: "TSHH-399 A/B/C", value: "149°C", logic: "3選2" },
                        { reason: "D-2012A 高高液位", tag: "LSHH-408", value: "-", logic: "" },
                        { reason: "D-2013A 高高液位", tag: "LSHH-410", value: "-", logic: "" }
                    ],
                    "Mechanical": [
                        { reason: "機架滑油壓力低", tag: "PALL-768", value: "1.7 kg/cm²", logic: "" },
                        { reason: "注油器低液面", tag: "LALL-566", value: "3.5 kg/cm²", logic: "" },
                        { reason: "溫水壓力低", tag: "PALL-774", value: "1.76 kg/cm²", logic: "" },
                        { reason: "主馬達線圈溫度高", tag: "TAHH-496 B/D/F", value: "140°C", logic: "" },
                        { reason: "手動跳車按鈕", tag: "HS-955 A/B", value: "控制室/L.P", logic: "" }
                    ]
                },
                "C-2001B": {
                    "hasSub": true,
                    "Process": [
                        { reason: "一級進口低低壓力", tag: "PSLL-612 A/B/C", value: "14.8 kg/cm²", logic: "3選2" },
                        { reason: "一級出口高高溫度", tag: "TSHH-400 A/B/C", value: "149°C", logic: "3選2" },
                        { reason: "二級出口高高溫度", tag: "TSHH-401 A/B/C", value: "149°C", logic: "3選2" },
                        { reason: "三級出口高高溫度", tag: "TSHH-402 A/B/C", value: "149°C", logic: "3選2" },
                        { reason: "D-2012A 高高液位", tag: "LSHH-415", value: "-", logic: "" },
                        { reason: "D-2013A 高高液位", tag: "LSHH-417", value: "-", logic: "" }
                    ],
                    "Mechanical": [
                        { reason: "機架滑油壓力低", tag: "PALL-769", value: "1.7 kg/cm²", logic: "" },
                        { reason: "注油器低液面", tag: "LALL-567", value: "3.5 kg/cm²", logic: "" },
                        { reason: "溫水壓力低", tag: "PALL-775", value: "1.76 kg/cm²", logic: "" },
                        { reason: "主馬達線圈溫度高", tag: "TAHH-497 B/D/F", value: "140°C", logic: "" },
                        { reason: "手動跳車按鈕", tag: "HS-959 A/B", value: "控制室/L.P", logic: "" }
                    ]
                },
                "C-2001C": {
                    "hasSub": true,
                    "Process": [
                        { reason: "一級進口低低壓力", tag: "PSLL-620 A/B/C", value: "14.8 kg/cm²", logic: "3選2" },
                        { reason: "各級出口高高溫度", tag: "TSHH-403~405", value: "149°C", logic: "3選2" },
                        { reason: "D-2012A 高高液位", tag: "LSHH-422", value: "-", logic: "" },
                        { reason: "D-2013A 高高液位", tag: "LSHH-424", value: "-", logic: "" }
                    ],
                    "Mechanical": [
                        { reason: "機架滑油壓力低", tag: "PALL-770", value: "1.7 kg/cm²", logic: "" },
                        { reason: "注油器低液面", tag: "LALL-568", value: "3.5 kg/cm²", logic: "" },
                        { reason: "溫水壓力低", tag: "PALL-776", value: "1.76 kg/cm²", logic: "" },
                        { reason: "主馬達線圈溫度高", tag: "TAHH-498 B/D/F", value: "140°C", logic: "" },
                        { reason: "手動跳車按鈕", tag: "HS-963 A/B", value: "控制室/L.P", logic: "" }
                    ]
                },
                "C-2002": {
                    "hasSub": true,
                    "Process": [
                        { reason: "出口高高溫度", tag: "TSHH-406 A/B/C", value: "193°C", logic: "3選2" },
                        { reason: "出口低低流量", tag: "FSLL-140 A/B/C", value: "100 M³/H", logic: "3選2 (Override可)" },
                        { reason: "D-2014 高高液位", tag: "LSHH-479", value: "-", logic: "3選2" },
                        { reason: "進口低低壓力", tag: "PSLL-654 A/B/C", value: "0.14 kg/cm²", logic: "3選2" },
                        { reason: "D-2005 高高液位", tag: "LSHH-455", value: "-", logic: "3選2 (不連鎖其他)" }
                    ],
                    "Mechanical": [
                        { reason: "滑油壓力低", tag: "PALL-791", value: "0.56 kg/cm²", logic: "Delay 1s" },
                        { reason: "頂部密封油槽液面低", tag: "LALL-556", value: "2502mm", logic: "Top起, Delay 1s" },
                        { reason: "密封油/氣差壓低", tag: "DPALL-786", value: "0.21 kg/cm²", logic: "Delay 1s" },
                        { reason: "轉軸徑向高震動", tag: "Vib High", value: "63.5 um", logic: "Delay 1s" },
                        { reason: "轉軸軸向高位移", tag: "Disp High", value: "304.8 um", logic: "Delay 1s" },
                        { reason: "超速跳車", tag: "Overspeed", value: "12628 rpm", logic: "" },
                        { reason: "手動跳車按鈕", tag: "HS-906", value: "控制室", logic: "" }
                    ]
                },
                "C-2003A": {
                    "hasSub": true,
                    "Process": [
                        { reason: "D-2014 高高液位", tag: "LSHH-479 A/B/C", value: "-", logic: "3選2 (Common)" },
                        { reason: "第一級出口高高溫度", tag: "TSHH-408", value: "140°C", logic: "" },
                        { reason: "第二級出口高高溫度", tag: "TSHH-419", value: "99°C", logic: "" },
                        { reason: "進口低低壓力", tag: "PSLL-654 A/B/C", value: "0.14 kg/cm²", logic: "3選2" },
                        { reason: "D-2034A 高高液位", tag: "LSHH-528", value: "-", logic: "" }
                    ],
                    "Mechanical": [
                        { reason: "曲軸箱滑油壓力低", tag: "PALL-838", value: "0.35 kg/cm²", logic: "" },
                        { reason: "注油器液面低", tag: "LALL-579", value: "3.52 kg/cm²", logic: "" },
                        { reason: "溫水壓力低", tag: "PALL-840", value: "0.35 kg/cm²", logic: "" },
                        { reason: "手動跳車按鈕", tag: "HS-938A", value: "控制室", logic: "" }
                    ]
                },
                "C-2003B": {
                    "hasSub": true,
                    "Process": [
                        { reason: "D-2014 高高液位", tag: "LSHH-479 A/B/C", value: "-", logic: "3選2 (Common)" },
                        { reason: "第一級出口高高溫度", tag: "TSHH-409", value: "140°C", logic: "" },
                        { reason: "第二級出口高高溫度", tag: "TSHH-420", value: "99°C", logic: "" },
                        { reason: "進口低低壓力", tag: "PSLL-656 A/B/C", value: "0.14 kg/cm²", logic: "3選2" },
                        { reason: "D-2034B 高高液位", tag: "LSHH-531", value: "-", logic: "" }
                    ],
                    "Mechanical": [
                        { reason: "曲軸箱滑油壓力低", tag: "PALL-839", value: "0.35 kg/cm²", logic: "" },
                        { reason: "注油器液面低", tag: "LALL-580", value: "3.52 kg/cm²", logic: "" },
                        { reason: "溫水壓力低", tag: "PALL-841", value: "0.35 kg/cm²", logic: "" },
                        { reason: "手動跳車按鈕", tag: "HS-930A", value: "控制室", logic: "" }
                    ]
                },
                "C-2004": { "hasSub": false, "list": [
                    { reason: "出口低壓力", tag: "PSL-681", value: "50 mmH2O", logic: "Auto Start 備用泵" }
                ]},
                "C-2005": { "hasSub": false, "list": [
                    { reason: "進出口高差壓", tag: "PDSLL-733 A/B/C", value: "80 mmH2O", logic: "觸發開啟XV-941" },
                    { reason: "C-2005 跳車", tag: "Timer", value: "5 sec", logic: "XV-941未全開則跳車" }
                ]}
            },
            "Furnace": {
                "F-2001": { "hasSub": false, "list": [
                    { reason: "F.G 低壓力", tag: "PSLL-713 A/B/C", value: "0.07 kg/cm²", logic: "4選2" },
                    { reason: "空氣低流量", tag: "FSLL-081 A/B/C", value: "5000 NM³/h", logic: "" },
                    { reason: "手動跳車按鈕", tag: "HS-995 A/B", value: "控制室", logic: "" }
                ]},
                "F-2002": { "hasSub": false, "list": [
                    { reason: "F.G 低壓力", tag: "PSLL-715 A/B/C", value: "0.17 kg/cm²", logic: "4選2" },
                    { reason: "空氣低流量", tag: "FSLL-085 A/B/C", value: "1500 NM³/h", logic: "" },
                    { reason: "手動跳車按鈕", tag: "HS-988 A/B", value: "控制室", logic: "" }
                ]}
            },
            "Pump": {
                // Pump 類別因為跳車點少，保持單頁顯示，但在表格內區分
                "P-2001A/B": { "hasSub": false, "list": [
                    { reason: "滑油低低壓力", tag: "PSLL-798(A)/800(B)", value: "0.98/0.7 kg/cm²", logic: "3選2" },
                    { reason: "馬達線圈高溫度", tag: "TSHH-464/466", value: "160°C", logic: "B/D/F" }
                ]},
                "P-2002A/B": { "hasSub": false, "list": [
                    { reason: "滑油低低壓力", tag: "PSLL-802(A)/804(B)", value: "0.98/0.84 kg/cm²", logic: "3選2" },
                    { reason: "馬達線圈高溫度", tag: "TSHH-468/470", value: "160°C", logic: "B/D/F" }
                ]},
